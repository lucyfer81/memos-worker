# 链接与 Inbox 手工验收脚本

## 目标
验证以下行为是否符合预期：

1. 创建新卡片后会弹出“关联决策面板”
2. 三种决策路径都可完成且状态正确：
   - `📥 存入收件箱`
   - `设为新主题起点`
   - `保存关联并完成`
3. 面板未决策时关闭页面，会自动兜底到 Inbox
4. 重新打开待关联卡片时，会再次提醒并进入关联流程

## 前置条件

1. 启动本地服务：
```bash
npm run dev local
```
2. 浏览器打开 `http://127.0.0.1:8787`（或 Wrangler 输出端口）
3. 登录账号（默认）：
   - 用户名：`admin`
   - 密码：`test123`
4. 打开浏览器 DevTools 的 `Network`（便于观察接口）和 `Console`（便于可选核验）

## 测试数据准备（一次即可）

先准备 2 条“可被关联”的卡片（非 pending）：

1. 新建卡片：`[候选A] 语义候选卡片 A #candidate`
2. 弹面板后点击 `设为新主题起点`
3. 新建卡片：`[候选B] 语义候选卡片 B #candidate`
4. 弹面板后点击 `设为新主题起点`

预期：

1. 两条卡片均保存成功
2. 不带 `#inbox`
3. 后续可在“关联搜索”里搜到

---

## 场景 1：创建后选择“存入收件箱”

步骤：

1. 新建卡片：`[CASE1] 先暂存到 inbox`
2. 在关联面板点击 `📥 存入收件箱`

预期：

1. 出现成功提示（存入收件箱）
2. 卡片内容包含 `#inbox`
3. 再次打开该卡片时，显示待关联状态（左侧高亮边框 / 强制关联入口）
4. Network 可见 `POST /api/notes/{id}/inbox`

---

## 场景 2：创建后选择“设为新主题起点”

步骤：

1. 新建卡片：`[CASE2] 新主题起点`
2. 在关联面板点击 `设为新主题起点`

预期：

1. 保存成功
2. 卡片不包含 `#inbox`
3. 该卡片不再触发“待关联强提醒”
4. Network 可见：
   - `PATCH /api/notes/{id}/status`（`orphan`）
   - `DELETE /api/notes/{id}/inbox`

---

## 场景 3：创建后选择“关联某条卡片并完成”

步骤：

1. 新建卡片：`[CASE3] 需要关联候选A`
2. 在关联面板中选择 1 条卡片（推荐选 `候选A`）
3. 为该条选择一个 link type（如 `supports`）
4. 点击 `保存关联并完成`

预期：

1. 保存成功，提示已创建关联
2. 卡片不包含 `#inbox`
3. Network 可见：
   - `POST /api/notes/{id}/links`
   - `DELETE /api/notes/{id}/inbox`
4. 如果不选任何卡片直接点“保存关联并完成”，应被阻止并出现提示

---

## 场景 4：未决策直接关页，自动恢复到 Inbox

步骤：

1. 新建卡片：`[CASE4] 关页恢复测试`
2. 等关联面板弹出，不点任何决策按钮
3. 直接刷新页面或关闭当前标签页
4. 重新打开应用并登录

预期：

1. 页面恢复后出现提示：已恢复上次未完成的关联决策（已转入收件箱）
2. 该卡片内容包含 `#inbox`
3. 该卡片是待关联状态
4. 关页前后可在 Network 看到 `POST /api/notes/{id}/inbox`（可能来自 `sendBeacon/keepalive`）

---

## 场景 5：再次打开待关联卡片，会强提醒

步骤：

1. 找到任意待关联卡片（可用 CASE1 或 CASE4）
2. 点击卡片上的 `强制关联` 按钮
3. 关闭面板后，再尝试点 `Edit` 或 `Fullscreen Edit`

预期：

1. 点击 `强制关联` 必然弹出关联面板
2. 点击编辑入口时，若仍是 pending，会先弹关联面板并给出提醒
3. 完成“设为新主题起点”或“保存关联并完成”后，上述强提醒消失

---

## 可选快速核验（Console）

在浏览器 Console 执行（需已登录）：

```js
async function note(id) {
  const r = await fetch(`/api/notes/${id}`);
  return r.json();
}
```

核验点：

1. `content` 是否包含 `#inbox`
2. `link_status` 是否符合预期：
   - Inbox 路径：`pending`
   - 新主题路径：`orphan`
   - 建立关联路径：`linked`（由 link trigger 维护）

---

## 通过标准

以下全部满足则本轮通过：

1. 三种决策路径均可成功完成，且状态与标签一致
2. 未决策关页后可恢复为 Inbox（不丢卡片，不丢提醒）
3. 待关联卡片存在稳定的“强制关联”入口与再次打开提醒
