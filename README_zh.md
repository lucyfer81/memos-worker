[English](./README.md)

# Memos Worker: ç”± Cloudflare é©±åŠ¨çš„ç¬”è®°ä¸çŸ¥è¯†åº“

![1](./image/1.png)
![1](./image/2.png)
![1](./image/3.png)
![1](./image/4.png)

**Memos Worker** æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€æ€§èƒ½å“è¶Šçš„æ— æœåŠ¡å™¨ç¬”è®°å’ŒçŸ¥è¯†åº“åº”ç”¨ã€‚å®ƒå®Œå…¨æ„å»ºåœ¨ Cloudflare çš„ç”Ÿæ€ç³»ç»Ÿä¹‹ä¸Šï¼ˆWorkers, Pages, D1, R2, KVï¼‰ï¼Œä¸ºä½ æä¾›ä¸€ä¸ªå¯ä»¥æ°¸ä¹…æ‹¥æœ‰ã€è¿‘ä¹é›¶æˆæœ¬çš„ç§æœ‰åŒ–ç¬”è®°è§£å†³æ–¹æ¡ˆã€‚

## âœ¨ åŠŸèƒ½ç‰¹ç‚¹

-   **âœï¸ Markdown å…¨åŠŸèƒ½æ”¯æŒ**: æ”¯æŒå®æ—¶é¢„è§ˆã€åˆ†æ ç¼–è¾‘ï¼Œå¹¶èƒ½ä»å¯Œæ–‡æœ¬æ™ºèƒ½ç²˜è´´ä¸º Markdownã€‚
-   **ğŸ›ï¸ çµæ´»è§†å›¾ä¸å·¥ä½œæµ**: æ”¯æŒç¬”è®°çš„å½’æ¡£ã€æ”¶è—ä¸ç½®é¡¶ã€‚æä¾›å®½å±ã€ç€‘å¸ƒæµã€æ—¥æœŸåˆ†ç»„ç­‰å¤šç§è§†å›¾æ¨¡å¼ã€‚
-   **ğŸ“š å¼ºå¤§ç»„ç»‡èƒ½åŠ›**: è‡ªåŠ¨æ ‡ç­¾ã€å…¨æ–‡æœç´¢ã€æ—¶é—´çº¿ã€æ—¥å†å’Œæ´»åŠ¨çƒ­åŠ›å›¾ã€‚
-   **ğŸ—‚ï¸ æ–‡ä»¶ä¸é™„ä»¶**: æ”¯æŒæ‹–æ‹½æˆ–ç²˜è´´ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯å­˜è‡³ R2 æˆ– Imgurï¼‰åŠå„ç±»æ–‡ä»¶é™„ä»¶ã€‚
-   **ğŸ”— å…¬å¼€åˆ†äº«**: å¯ä»¥ä¸ºç¬”è®°ä¸­çš„ä»»æ„ Memos æˆ–æ–‡ä»¶ç”Ÿæˆå”¯ä¸€çš„å…¬å¼€è®¿é—®é“¾æ¥ï¼Œå¹¶æ”¯æŒè®¾ç½®è¿‡æœŸæ—¶é—´ã€‚
-   **ğŸ¤– Telegram é›†æˆ**: é€šè¿‡ Telegram Bot éšæ—¶éšåœ°è®°å½•æ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘å’Œæ–‡ä»¶ã€‚
-   **ğŸ¨ é«˜åº¦å¯å®šåˆ¶**: æ”¯æŒæµ…è‰²/æ·±è‰²ä¸»é¢˜ã€è‡ªå®šä¹‰ä¸»è‰²è°ƒã€èƒŒæ™¯å›¾ç‰‡ã€ç»ç’ƒæ¨¡ç³Šæ•ˆæœï¼Œä»¥åŠå¯¹å¸ƒå±€å’ŒåŠŸèƒ½å¯è§æ€§çš„ç²¾ç»†è°ƒæ•´ã€‚
-   **ğŸ“ƒ çŸ¥è¯†åº“ (Docs)**: ç‹¬ç«‹çš„æ ‘çŠ¶æ–‡æ¡£ä¸­å¿ƒï¼Œé€‚åˆæ„å»ºç»“æ„åŒ–çš„çŸ¥è¯†ä½“ç³»ã€‚
-   **ğŸš€ æè‡´æ€§èƒ½ä¸ä½æˆæœ¬**: åŸºäº Cloudflare å…¨çƒç½‘ç»œï¼Œå“åº”è¿…é€Ÿï¼Œåœ¨å…è´¹å¥—é¤é¢åº¦å†…å‡ ä¹é›¶æˆæœ¬è¿è¡Œã€‚

## ğŸš€ éƒ¨ç½²æŒ‡å—

### ç¬¬ 1 æ­¥: é€‰æ‹©ä½ çš„ä»“åº“åˆ›å»ºæ–¹å¼

ä½ æœ‰ä¸¤ç§æ–¹å¼æ¥åˆ›å»ºä½ è‡ªå·±çš„ä»£ç ä»“åº“ï¼Œè¯·æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©å…¶ä¸€ã€‚

#### é€‰é¡¹ A: Fork (æ¨èï¼Œä¾¿äºæ›´æ–°)
-   **ä¼˜ç‚¹**: ä½ çš„ä»“åº“ä¼šä¸æˆ‘ä»¬çš„åŸå§‹ä»“åº“ä¿æŒå…³è”ã€‚å½“é¡¹ç›®æœ‰æ–°åŠŸèƒ½æˆ–ä¿®å¤æ—¶ï¼Œä½ å¯ä»¥è½»æ¾åœ°ä» GitHub åŒæ­¥è¿™äº›æ›´æ–°ã€‚
-   **ç¼ºç‚¹**: ä½ çš„ä»£ç ä»“åº“æ˜¯**å…¬å¼€**çš„ã€‚ï¼ˆç”±äºå…³é”®ä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼Œå”¯ä¸€æš´éœ²çš„æ˜¯cloudflareçš„æ•°æ®åº“ã€KVã€R2çš„idï¼Œä½†é€šå¸¸ä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆäº‹ï¼‰
-   **æ“ä½œ**: ç‚¹å‡»æœ¬é¡µé¢å³ä¸Šè§’çš„ **"Fork"** æŒ‰é’®ã€‚

#### é€‰é¡¹ B: ä½¿ç”¨æ¨¡æ¿ (ä»“åº“å¯è®¾ä¸ºç§æœ‰)
-   **ä¼˜ç‚¹**: ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ã€ç‹¬ç«‹çš„ã€å¹¶ä¸”**ç§æœ‰**çš„ä»£ç ä»“åº“ã€‚
-   **ç¼ºç‚¹**: ä½ çš„ä»“åº“å°†ä¸åŸå§‹é¡¹ç›®å®Œå…¨ç‹¬ç«‹ï¼Œ**æ— æ³•è‡ªåŠ¨æˆ–è½»æ¾åœ°è·å–æœªæ¥çš„æ›´æ–°**ã€‚ä½ éœ€è¦æ‰‹åŠ¨é€šè¿‡ Git å‘½ä»¤æ¥åŒæ­¥ï¼Œè¿‡ç¨‹è¾ƒä¸ºå¤æ‚ã€‚
-   **æ“ä½œ**: ç‚¹å‡»æœ¬é¡µé¢å³ä¸Šè§’çš„ **"Use this template"** -> **"Create a new repository"**ã€‚

### ç¬¬ 2 æ­¥: åˆ›å»º Cloudflare èµ„æº

ä½ éœ€è¦åœ¨ Cloudflare Dashboard ä¸­æ‰‹åŠ¨åˆ›å»ºå¥½é¡¹ç›®æ‰€éœ€çš„ D1 æ•°æ®åº“ã€R2 å­˜å‚¨æ¡¶å’Œ KV å‘½åç©ºé—´ã€‚

| èµ„æºç±»å‹ | æ¨èåç§° | ç»‘å®šå˜é‡å |
| --------------- | ----------------- | ----------------- |
| **D1 æ•°æ®åº“** | `notes-db` | `DB` |
| **KV å‘½åç©ºé—´** | `notes-kv` | `NOTES_KV` |
| **R2 å­˜å‚¨æ¡¶** | `notes-r2-bucket` | `NOTES_R2_BUCKET` |

1.  **åˆ›å»º D1 æ•°æ®åº“ (`notes-db`)**:
	-   è¿›å…¥ **Workers & Pages** -> **D1** -> **Create database**ã€‚
	-   **é‡è¦**: åˆ›å»ºåï¼Œè¿›å…¥æ•°æ®åº“æ§åˆ¶å°ï¼Œå°†é¡¹ç›®ç›®å½•ä¸‹çš„ `schema.sql` æ–‡ä»¶å†…å®¹å®Œæ•´å¤åˆ¶è¿›å»å¹¶æ‰§è¡Œã€‚
    -   **é‡è¦**: è®°ä¸‹database_idå’Œdatabase_nameï¼Œå†™å…¥ `wrangler.toml` æ–‡ä»¶çš„ `[[d1_databases]]` éƒ¨åˆ†ã€‚

2.  **åˆ›å»º KV å‘½åç©ºé—´ (`notes-kv`)**:
	-   è¿›å…¥ **Workers & Pages** -> **KV** -> **Create a namespace**ã€‚
	-   **é‡è¦**: è®°ä¸‹ `id`ã€‚å°†å…¶å¡«å…¥ `wrangler.toml` æ–‡ä»¶çš„ `[[kv_namespaces]]` éƒ¨åˆ†ã€‚

3.  **åˆ›å»º R2 å­˜å‚¨æ¡¶ (`notes-r2-bucket`)**:
	-   è¿›å…¥ **R2** -> **Create bucket**ã€‚
	-   **é‡è¦**: è®°ä¸‹ `bucket_name`ã€‚å°†å…¶å¡«å…¥ `wrangler.toml` æ–‡ä»¶çš„ `[[r2_buckets]]` éƒ¨åˆ†ã€‚

### ç¬¬ 3 æ­¥: éƒ¨ç½²åˆ° Cloudflare Workers

1.  è¿›å…¥ Cloudflare Dashboard -> **Workers & Pages** -> **Create application** -> **é€‰æ‹©Workers** -> **è¿æ¥åˆšæ‰åˆ›å»ºçš„Gitåº“**ã€‚
2.  é€‰æ‹©ä½  Fork çš„ä»“åº“ï¼Œç„¶åç›´æ¥ç‚¹å‡» **Save and Deploy**ã€‚

### ç¬¬ 4 æ­¥: é…ç½®ç¯å¢ƒå˜é‡

éƒ¨ç½²å®Œæˆåï¼Œè¿›å…¥ä½ åˆ›å»ºçš„ Worker é¡¹ç›®è¿›è¡Œé…ç½®ã€‚

1.  è¿›å…¥é¡¹ç›® -> **Settings**ï¼Œè¿›å…¥ **Environment Variables**ï¼Œæ·»åŠ ä»¥ä¸‹å˜é‡ï¼š

	| Variable Name           | Description                          |
    | ----------------------- | ------------------------------------ |
	| `USERNAME`              | ä½ çš„ç™»å½•ç”¨æˆ·å                       |
	| `PASSWORD`              | ä½ çš„ç™»å½•å¯†ç                          |
	| `TELEGRAM_BOT_TOKEN`    | (å¯é€‰) Telegram æœºå™¨äººçš„ Token       |
	| `TELEGRAM_WEBHOOK_SECRET` | (å¯é€‰) ä¸€ä¸ªéšæœºé•¿å­—ç¬¦ä¸²ç”¨äº Webhook éªŒè¯ |
	| `AUTHORIZED_TELEGRAM_IDS` | (å¯é€‰) æˆæƒä½¿ç”¨æœºå™¨äººçš„ Telegram ç”¨æˆ· ID |

2.  é‡æ–°éƒ¨ç½²ï¼Œè®©æ‰€æœ‰é…ç½®ç”Ÿæ•ˆã€‚

### ç¬¬ 5 æ­¥: (å¯é€‰) æ¿€æ´» Telegram Webhook

å¦‚æœä½ é…ç½®äº† Telegram ç›¸å…³çš„å˜é‡ï¼Œä½ éœ€è¦ä¸€æ¬¡æ€§åœ°æ¿€æ´» Webhookã€‚

1.  è·å–ä½ çš„åº”ç”¨ URL (ä¾‹å¦‚ `https://your-project.pages.dev`)ã€‚
2.  åœ¨ä½ çš„æµè§ˆå™¨åœ°å€æ ä¸­ï¼Œæ„é€ å¦‚ä¸‹çš„ Webhook æ¿€æ´»é“¾æ¥ï¼š
	```
	https://api.telegram.org/bot<TELEGRAM_BOT_TOKEN>/setWebhook?url=https://your-project.pages.dev/api/telegram_webhook/<TELEGRAM_WEBHOOK_SECRET>&secret_token=<TELEGRAM_WEBHOOK_SECRET>
	```
3.  **æ›¿æ¢**é“¾æ¥ä¸­çš„ `<TELEGRAM_BOT_TOKEN>` å’Œ `<TELEGRAM_WEBHOOK_SECRET>` ä¸ºä½ è‡ªå·±çš„çœŸå®å¯†é’¥å€¼ã€‚
4.  æŒ‰ä¸‹å›è½¦ã€‚å¦‚æœä½ çœ‹åˆ° `{"ok":true,"result":true,"description":"Webhook was set"}` çš„è¿”å›ä¿¡æ¯ï¼Œå³ä»£è¡¨è®¾ç½®æˆåŠŸï¼ä½ ç°åœ¨å¯ä»¥ç»™ä½ çš„æœºå™¨äººå‘é€æ¶ˆæ¯äº†ã€‚

---

> æ­¤å¤–è¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨wranglerï¼Œé€šè¿‡å‘½ä»¤è¡Œéƒ¨ç½²ï¼ˆæˆ‘ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯^4.33.0ï¼‰
>
> 1. å…‹éš†ä»“åº“åˆ°æœ¬åœ°ï¼ŒæŠŠKV D1 R2çš„é…ç½®å¡«å…¥åˆ°wrangler.tomlé‡Œé¢
> 2. æ‰§è¡Œ`npx wrangler deploy`

## ğŸ’¡ ä½¿ç”¨æŠ€å·§

-   **é¢„è§ˆåŸå§‹æ–‡ä»¶å†…å®¹**: åœ¨ä¸»ç•Œé¢æˆ–å…¬å¼€åˆ†äº«é¡µé¢ï¼Œä½ å¯ä»¥**å³é”®ç‚¹å‡»**ä»»ä½•åŸºäºæ–‡æœ¬çš„é™„ä»¶ï¼ˆå¦‚ `.txt`, `.md`, `.json`, `.js`ï¼‰ï¼Œåœ¨æ–°æ ‡ç­¾é¡µä¸­ç›´æ¥æ‰“å¼€å¹¶é¢„è§ˆå…¶åŸå§‹å†…å®¹ã€‚
-   **ç†è§£ 'Telegram Proxy' çš„ä½œç”¨**: è¿™ä¸ªåœ¨è®¾ç½®é¢æ¿ä¸­çš„é€‰é¡¹ï¼Œç”¨äºæ§åˆ¶å¦‚ä½•å¤„ç†ä» Telegram å‘é€çš„è§†é¢‘å’Œæ–‡ä»¶ã€‚
    -   **ä»£ç†å¼€å¯**: èŠ‚çœ R2 å­˜å‚¨ç©ºé—´ã€‚ä½ çš„åº”ç”¨ä¼šåˆ›å»ºä¸€ä¸ªæŒ‡å‘ Telegram æ–‡ä»¶çš„â€œä»£ç†â€é“¾æ¥ã€‚**é£é™©**: å¦‚æœåŸå§‹æ–‡ä»¶ä» Telegram è¢«åˆ é™¤ï¼Œä½ çš„é“¾æ¥å°†ä¼šå¤±æ•ˆã€‚
    -   **ä»£ç†å…³é—­**: ä½¿ç”¨ R2 å­˜å‚¨ã€‚ä½ çš„åº”ç”¨ä¼šä» Telegram ä¸‹è½½æ–‡ä»¶å¹¶é‡æ–°ä¸Šä¼ åˆ°ä½ è‡ªå·±çš„ R2 æ¡¶ä¸­ï¼Œä»¥ç¡®ä¿ä½ æ‹¥æœ‰ä¸€ä¸ªæ°¸ä¹…çš„å‰¯æœ¬ã€‚
-   **ç†è§£ (Keep Time) çš„ä½œç”¨**: åœ¨ç¼–è¾‘ç¬”è®°æ—¶ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ª "Keep Time" çš„å¤é€‰æ¡†ã€‚
    -   **å‹¾é€‰ (é»˜è®¤)**: ä¿å­˜ç¼–è¾‘åï¼Œç¬”è®°çš„åŸå§‹æ—¶é—´æˆ³å°†è¢«ä¿ç•™ï¼Œå®ƒ**ä¸ä¼š**è·‘åˆ°æ—¶é—´çº¿çš„é¡¶ç«¯ã€‚
    -   **ä¸å‹¾é€‰**: ä¿å­˜åï¼Œç¬”è®°çš„æ—¶é—´æˆ³ä¼šæ›´æ–°ä¸ºå½“å‰æ—¶é—´ï¼Œä½¿å…¶æˆä¸ºæœ€æ–°çš„ç¬”è®°ã€‚

## ğŸ” é‡å»ºæœç´¢ç´¢å¼• (æ¨è)

å¦‚æœä½ æ˜¯ä»æ—§ç‰ˆæœ¬ï¼ˆ20260206ä¹‹å‰ç‰ˆæœ¬ï¼‰æ›´æ–°çš„ï¼Œå¹¶ä¸”æƒ³è¦å®ç°**æœç´¢æ–‡ä»¶å**çš„åŠŸèƒ½ï¼Œä½ éœ€è¦é‡å»ºå…¨æ–‡æœç´¢ (FTS) ç´¢å¼•ã€‚

1.  è¿›å…¥ Cloudflare Dashboard -> **Workers & Pages** -> **D1**ã€‚
2.  é€‰æ‹©ä½ çš„æ•°æ®åº“ (ä¾‹å¦‚ `notes-db`)ã€‚
3.  ç‚¹å‡» **Console** é€‰é¡¹å¡ã€‚
4.  å¤åˆ¶æœ¬é¡¹ç›®ä¸­ `src/migrate_fts.sql` æ–‡ä»¶çš„å®Œæ•´å†…å®¹å¹¶ç²˜è´´åˆ°æ§åˆ¶å°ã€‚
5.  ç‚¹å‡» **Execute**ã€‚

è¿™å°†æ›´æ–°ä½ çš„æœç´¢ç´¢å¼•ä»¥åŒ…å«æ–‡ä»¶åï¼Œå¹¶åˆ·æ–°æ‰€æœ‰ç°æœ‰æ•°æ®ã€‚

## ğŸ”§ é¡¹ç›®å¼€å‘ (Wrangler)

### 1. æœ¬åœ°å¼€å‘ (æ¨¡æ‹Ÿç¯å¢ƒ)

**åˆå§‹åŒ–æœ¬åœ°æ•°æ®åº“**:
```bash
npx wrangler d1 execute YOUR_D1_NAME --local --file=./src/schema.sql
```

**å¯åŠ¨å¼€å‘æœåŠ¡å™¨**:
```bash
npx wrangler dev
```

### 2. æœ¬åœ°å¼€å‘ (è¿æ¥äº‘ç«¯çœŸå®èµ„æº)

æ­¤æ¨¡å¼å°†ä½ çš„æœ¬åœ°å¼€å‘æœåŠ¡å™¨è¿æ¥åˆ°ä½ åœ¨ Cloudflare ä¸Šåˆ›å»ºçš„çœŸå®èµ„æºã€‚

1.  **é…ç½® `wrangler.toml`**: ç¡®ä¿ä½ åœ¨ Cloudflare Dashboard ä¸­åˆ›å»ºçš„èµ„æº ID å·²ç»å¡«å…¥æ­¤æ–‡ä»¶ã€‚
	```toml
	# wrangler.toml
	[[d1_databases]]
	binding = "DB"
	database_name = "notes-db"
	database_id = "YOUR_D1_DATABASE_ID" # æ›¿æ¢

	[[kv_namespaces]]
	binding = "NOTES_KV"
	id = "YOUR_KV_NAMESPACE_ID" # æ›¿æ¢

	[[r2_buckets]]
	binding = "NOTES_R2_BUCKET"
	bucket_name = "notes-r2-bucket"
	```
2.  **åˆ›å»º `.dev.vars` æ–‡ä»¶**: åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºæ­¤æ–‡ä»¶ï¼Œç”¨äºå­˜æ”¾ä½ çš„æœ¬åœ°å¯†é’¥ã€‚
	```ini
	# .dev.vars (æ­¤æ–‡ä»¶ä¼šè¢« Git å¿½ç•¥)
	USERNAME="dev_user"
	PASSWORD="dev_password"
	```
3.  **å¯åŠ¨è¿æ¥åˆ°äº‘ç«¯çš„å¼€å‘æœåŠ¡å™¨**:
	```bash
	npx wrangler dev --remote
	```
